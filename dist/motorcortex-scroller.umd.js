!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i(require("@donkeyclip/motorcortex")):"function"==typeof define&&define.amd?define(["@donkeyclip/motorcortex"],i):(t="undefined"!=typeof globalThis?globalThis:t||self)["@donkeyclip/motorcortex-scroller"]=i(t.MotorCortex)}(this,(function(t){"use strict";const i=new t.TimeCapsule,e="@donkeyclip/scrollbar_player";return class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.clip=e.clip,this.host=this.clip.props.host,this.swipeAxis="vertical"===(e.swipeAxis||"vertical")?"clientY":"clientX";const s=e.mode||"free";"free"===s?(this.host.onwheel=this.handlePlainWheel.bind(this),this.journey=i.startJourney(this.clip),this.host.addEventListener("touchstart",this._touchstart.bind(this)),this.host.addEventListener("touchmove",this._touchmove.bind(this))):"chapters"===s&&(this.transitionTimeout=null,this.transitionSpeed=e.transitionSpeed||1,this.easing=t.utils.easings[e.easing||"easeOutQuart"],this.transitionStart=null,e.chapters.sort((function(t,i){return t.millisecond-i.millisecond})),this.chapters=e.chapters,this.transitioning=!1,this.host.onwheel=this.handleChapterWheel.bind(this),this.host.addEventListener("touchstart",this._touchstart.bind(this)),this.host.addEventListener("touchmove",this._touchmove.bind(this)),this.host.addEventListener("touchend",this._chapterTouchend.bind(this)));const n=5/(e.wheelSpeed||5);this.speed=1/n;const o={display:!0,position:"right",color:"purple"};void 0!==e.progressBar&&Object.assign(o,e.progressBar),this._setupScrollbar(o)}_setupScrollbar(t){if(!1===t.display)return;const i=document.createElement("div");let s,n;switch(i.setAttribute("id","".concat(e,"-scrollbarId")),t.position){case"left":s="left:0px; top: 0px; width: 2px; height: 0%;",n="height";break;case"right":s="right:0px; top: 0px; width: 2px; height: 0%;",n="height";break;case"top":s="top:0px; left: 0px; height: 2px; width: 0%;",n="width";break;case"bottom":s="bottom:0px; left: 0px; height: 2px; width: 0%;",n="width"}i.setAttribute("style","".concat(s," position:absolute; background: ").concat(t.color,";")),this.host.appendChild(i),this.clip.subscribe("".concat(e,"_").concat((new Date).getTime()),(t=>{i.style[n]="".concat(100*t/this.clip.duration,"%")}))}_touchstart(t){t.preventDefault(),1===t.touches.length&&(this.previousTouch=t.touches[0][this.swipeAxis],this.transitioning=!1)}_touchmove(t){t.preventDefault(),this.transitioning=!1,null!==this.transitionTimeout&&clearTimeout(this.transitionTimeout);const e=this.previousTouch-event.touches[0][this.swipeAxis];this.direction=e>0?"fw":"bw",this.previousTouch=event.touches[0][this.swipeAxis];let s=10*e*this.speed;const n=i.startJourney(this.clip);let o=this.clip.runTimeInfo.currentMillisecond+s;o<0?(o=0,s=0):o>this.clip.duration&&(o=this.clip.duration,s=0),n.destination(o)}_chapterTouchend(t){if(t.preventDefault(),"fw"===this.direction&&this.clip.runTimeInfo.currentMillisecond!==this.clip.duration){const t=this._getNextChapter(this.clip.runTimeInfo.currentMillisecond);this.transitionTimeout=setTimeout((()=>{this.transitionToChapter(t,"fw")}),this.latency)}else if("bw"===this.direction&&0!==this.clip.runTimeInfo.currentMillisecond){const t=this._getPreviousChapter(this.clip.runTimeInfo.currentMillisecond);this.transitionTimeout=setTimeout((()=>{this.transitionToChapter(t,"bw")}),this.latency)}}_getNextChapter(t){for(let i=0;i<this.chapters.length;i++){const e=this.chapters[i];if(e.millisecond>t)return e.millisecond}return this.clip.duration}_getPreviousChapter(t){for(let i=this.chapters.length-1;i>=0;i--){const e=this.chapters[i];if(e.millisecond<t)return e.millisecond}return 0}handleChapterWheel(t){t.preventDefault(),this.transitioning=!1,null!==this.transitionTimeout&&clearTimeout(this.transitionTimeout);let e=t.deltaY*this.speed;const s=i.startJourney(this.clip);let n=this.clip.runTimeInfo.currentMillisecond+e;if(n<0?(n=0,e=0):n>this.clip.duration&&(n=this.clip.duration,e=0),e>0){const t=this._getNextChapter(n);this.transitionTimeout=setTimeout((()=>{this.transitionToChapter(t,"fw")}),this.latency)}else if(e<0){const t=this._getPreviousChapter(n);this.transitionTimeout=setTimeout((()=>{this.transitionToChapter(t,"bw")}),this.latency)}s.destination(n)}transitionToChapter(t){this.transitioning=!0,this.transitionStart=null,this.targetMillisecond=t,this.startMillisecond=this.clip.runTimeInfo.currentMillisecond,this.journey=i.startJourney(this.clip),this.direction=this.targetMillisecond>=this.startMillisecond?"fw":"bw",window.requestAnimationFrame(this._step.bind(this))}_step(t){null===this.transitionStart&&(this.transitionStart=t);const i=t-this.transitionStart;let e,s=!1;if("fw"===this.direction?(e=this.startMillisecond+i*this.transitionSpeed,e>this.targetMillisecond&&(e=this.targetMillisecond,s=!0)):(e=this.startMillisecond-i*this.transitionSpeed,e<this.targetMillisecond&&(e=this.targetMillisecond,s=!0)),!1===this.transitioning)return;const n=Math.abs(e-this.startMillisecond)/Math.abs(this.targetMillisecond-this.startMillisecond);let o;o="fw"===this.direction?this.startMillisecond+this.easing(n)*(this.targetMillisecond-this.startMillisecond):this.startMillisecond-this.easing(n)*(this.startMillisecond-this.targetMillisecond),this.journey.station(o),s?this.journey.destination():window.requestAnimationFrame(this._step.bind(this))}handlePlainWheel(t){t.preventDefault();const i=t.deltaY*this.speed;let e=this.clip.runTimeInfo.currentMillisecond+i;e<0?e=0:e>this.clip.duration&&(e=this.clip.duration),this.journey.station(e)}}}));
